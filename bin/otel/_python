#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REQ_FILE="${SCRIPT_DIR}/requirements.txt"
VENV_DIR="${SCRIPT_DIR}/.venv"
REQ_STAMP_FILE="${VENV_DIR}/.requirements.sha256"

if command -v uv >/dev/null 2>&1; then
  if [[ -f "${REQ_FILE}" ]]; then
    exec uv run --with-requirements "${REQ_FILE}" python "$@"
  fi
  exec uv run python "$@"
fi

# Fallback path when uv is unavailable in PATH (common in subprocess shells).
# Keep a local venv and only refresh deps when requirements change.
if command -v flock >/dev/null 2>&1; then
  exec 9>"${SCRIPT_DIR}/.venv.lock"
  flock 9
fi

if [[ ! -x "${VENV_DIR}/bin/python" ]]; then
  if [[ -d "${VENV_DIR}" ]]; then
    python3 -m venv --clear "${VENV_DIR}"
  else
    python3 -m venv "${VENV_DIR}"
  fi
fi

if [[ -f "${REQ_FILE}" ]]; then
  if command -v sha256sum >/dev/null 2>&1; then
    req_hash="$(sha256sum "${REQ_FILE}" | awk '{print $1}')"
  else
    req_hash="$(shasum -a 256 "${REQ_FILE}" | awk '{print $1}')"
  fi
  existing_hash="$(cat "${REQ_STAMP_FILE}" 2>/dev/null || true)"
  if [[ "${req_hash}" != "${existing_hash}" ]]; then
    "${VENV_DIR}/bin/python" -m pip install --quiet --disable-pip-version-check -r "${REQ_FILE}"
    printf '%s\n' "${req_hash}" > "${REQ_STAMP_FILE}"
  fi
fi

exec "${VENV_DIR}/bin/python" "$@"
