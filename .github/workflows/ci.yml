name: CI

on:
  pull_request:
  push:
    branches:
      - main

jobs:
  skills-install-smoke:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Validate skill manifests
        shell: bash
        run: |
          set -euo pipefail
          python3 scripts/ci/validate_skills.py

      - name: List skills with npx
        shell: bash
        run: |
          set -euo pipefail
          npx -y skills add . --list --agent codex --agent claude-code > /tmp/skills-list.txt 2>&1
          cat /tmp/skills-list.txt

          for s in \
            pygraphistry \
            pygraphistry-core \
            pygraphistry-gfql \
            pygraphistry-visualization \
            pygraphistry-ai \
            pygraphistry-connectors
          do
            grep -q "$s" /tmp/skills-list.txt
          done

      - name: Install selected pygraphistry skills into temp project
        shell: bash
        run: |
          set -euo pipefail

          tmp_dir="$(mktemp -d)"
          cd "$tmp_dir"

          npx -y skills add "$GITHUB_WORKSPACE" \
            --agent codex \
            --agent claude-code \
            --skill pygraphistry \
            --skill pygraphistry-core \
            --skill pygraphistry-gfql \
            --skill pygraphistry-visualization \
            --skill pygraphistry-ai \
            --skill pygraphistry-connectors \
            --yes > /tmp/skills-install.txt 2>&1

          cat /tmp/skills-install.txt

          for s in \
            pygraphistry \
            pygraphistry-core \
            pygraphistry-gfql \
            pygraphistry-visualization \
            pygraphistry-ai \
            pygraphistry-connectors
          do
            test -f ".agents/skills/$s/SKILL.md"
            test -L ".claude/skills/$s"
          done

          # Ensure non-selected skills are not pulled in.
          test ! -e ".agents/skills/eval-otel"

      - name: Runtime native-load smoke (best effort on available runtimes)
        shell: bash
        run: |
          set -euo pipefail
          bash scripts/ci/runtime_native_smoke.sh
